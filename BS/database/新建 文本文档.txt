
DROP DATABASE IF EXISTS lianyuan_database;

CREATE DATABASE lianyuan_database 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_0900_ai_ci;

USE lianyuan_database;

CREATE TABLE users (
  user_id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL,
  account VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(100) NOT NULL,
  email VARCHAR(100) UNIQUE,
  address VARCHAR(255),
  phone VARCHAR(20) NOT NULL UNIQUE,
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE devices (
  device_id INT PRIMARY KEY AUTO_INCREMENT,
  device_name VARCHAR(100) NOT NULL,
  push_url VARCHAR(255) NOT NULL UNIQUE,
  pull_url VARCHAR(255) NOT NULL UNIQUE,
  province VARCHAR(50) NOT NULL,
  city VARCHAR(50) NOT NULL,
  location VARCHAR(255) NOT NULL,
  user_id INT NOT NULL,
  status TINYINT NOT NULL DEFAULT 1 COMMENT '1=在线,0=离线',
  install_time DATETIME NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE device_status (
  status_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  device_id INT NOT NULL,
  danger_level TINYINT NOT NULL DEFAULT 0 COMMENT '0=正常,1=警告,2=危险',
  danger_msg VARCHAR(255),
  image_url VARCHAR(255),
  video_url VARCHAR(255),
  record_time DATETIME NOT NULL,
  is_processed TINYINT NOT NULL DEFAULT 0 COMMENT '0=未处理,1=已处理',
  FOREIGN KEY (device_id) REFERENCES devices(device_id) ON DELETE CASCADE,
  INDEX idx_device_time (device_id, record_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

ALTER TABLE devices
ADD COLUMN device_code INT AFTER device_name;
ALTER TABLE devices MODIFY COLUMN device_code VARCHAR(20);


INSERT INTO users (
  user_id, 
  username, 
  account, 
  password, 
  email, 
  address, 
  phone, 
  create_time
) VALUES (
  1, 
  '1234567890', 
  '123', 
  '$2b$10$eipnqmC88G9kvi2GScSBBOjES0KU0WIAl0BMDlSWhkSsY7P56Z0XW', 
  NULL,  -- 对应空的email字段
  NULL,  -- 对应空的address字段
  '17357053826', 
  '2025-08-11 14:51:32'
);



INSERT INTO devices (
  device_id, 
  device_name, 
  device_code, 
  push_url, 
  pull_url, 
  province, 
  city, 
  location, 
  user_id, 
  status, 
  install_time
) VALUES (
  1, 
  '摄像头3232', 
  '865522078460315', 
  '没有', 
  'https://play.zhijingwuxian.com/zhijing/865522078460315_13zhen.m3u8?auth_key=1755055859-0-0-b0e6aedc289bc9a2f02edc7c29a15459', 
  '广东省', 
  '深圳市', 
  '东边村1号', 
  1,  -- 关联users表的user_id=1
  1,  -- 在线状态
  '2025-08-12 02:43:00'
);